{
  "type": "function",
  "function": {
    "name": "py_orchestrator",
    "displayName": "Python Orchestrator",
    "category": "intelligence",
    "tags": ["process", "python", "debug"],
    "description": "Run Python-defined workflows (Process/SubGraphs/Steps). Start/stop/status/debug; graph extraction; validate; transforms; config. Nouveau flux de création: start avec new_worker {first_name, template} (obligatoire) — aucun chemin/DB requis côté appelant. L'outil dérive le worker_name, localise le template dans workers/<template>/process.py, crée la DB et l'identité.",
    "parameters": {
      "type": "object",
      "properties": {
        "operation": {
          "type": "string",
          "enum": ["start", "stop", "status", "debug", "observe", "list", "graph", "validate", "transforms", "config"],
          "description": "Contrôle de l'orchestrateur"
        },
        "new_worker": {
          "type": "object",
          "description": "Création d'un nouveau worker à partir d'un template (obligatoire pour operation=start). Plus d'ancien schéma: pas de worker_name/worker_file fournis par l'appelant.",
          "properties": {
            "first_name": { "type": "string", "minLength": 1, "description": "Prénom (utilisé pour dériver le worker_name)" },
            "template": { "type": "string", "minLength": 1, "description": "Nom du template sous workers/<template>" }
          },
          "required": ["first_name", "template"],
          "additionalProperties": false
        },
        "worker_name": {
          "type": "string",
          "description": "Identifiant logique du worker (requis pour les opérations sur un worker existant: stop/status/debug/observe/graph/validate/transforms/config). Pour start, ne PAS fournir — utiliser new_worker."
        },
        "hot_reload": { "type": "boolean", "default": true, "description": "Hot-reload code & config" },
        "stop": { "type": "object", "properties": { "mode": { "type": "string", "enum": ["soft", "term", "kill"], "default": "soft" } }, "additionalProperties": false },
        "debug": {
          "type": "object",
          "description": "Debug actif (step/continue/run_until, breakpoints, inspect).",
          "properties": {
            "action": { "type": "string", "enum": ["enable", "enable_now", "step", "continue", "run_until", "break_add", "break_remove", "break_clear", "break_list", "inspect", "disable"] },
            "pause_at_start": { "type": "boolean" },
            "enable_on_start": { "type": "boolean" },
            "timeout_sec": { "type": "number" },
            "target": { "type": "object", "properties": { "node": { "type": "string" }, "when": { "type": "string" } }, "additionalProperties": false },
            "breakpoint": { "type": "object", "properties": { "node": { "type": "string" }, "when": { "type": "string" } }, "additionalProperties": false },
            "max_events": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false
        },
        "observe": {
          "type": "object",
          "description": "Observation passive (read-only). Retourne les évènements récents. NOTE: Le mode streaming (stream:true) est RÉSERVÉ aux apps clientes directes, PAS pour les appels LLM.",
          "properties": {
            "timeout_sec": { "type": "number", "description": "Durée maximale de l'observation (défaut: 30s, max: 86400s)" },
            "max_events": { "type": "integer", "minimum": 0, "description": "Nombre maximum d'événements à retourner (0 = illimité)" },
            "window_size": { "type": "integer", "minimum": 1, "maximum": 500, "default": 50, "description": "Taille de la fenêtre pour détecter les updates de steps (défaut: 50)" },
            "tick_sec": { "type": "number", "minimum": 0.1, "maximum": 2.0, "default": 0.2, "description": "Fréquence de polling en secondes (défaut: 0.2s)" },
            "from_rowid": { "type": "integer", "minimum": 0, "description": "Reprendre depuis un rowid spécifique (pour apps clientes uniquement)" }
          },
          "additionalProperties": false
        },
        "include_metrics": { "type": "boolean", "description": "Inclure métriques dans status" },
        "metrics": { "type": "object", "properties": { "include": { "type": "boolean" }, "window": { "type": "string" } }, "additionalProperties": false },
        "graph": {
          "type": "object",
          "description": "Extraction du graphe (process/subgraph/current_subgraph).",
          "properties": {
            "kind": { "type": "string", "enum": ["process", "subgraph", "current_subgraph"], "default": "process" },
            "subgraphs": { "type": "array", "items": { "type": "string" } },
            "recursive": { "type": "boolean", "default": true },
            "include": {
              "type": "object",
              "properties": {
                "shapes": { "type": "boolean", "default": true },
                "emojis": { "type": "boolean", "default": true },
                "labels": { "type": "boolean", "default": true }
              },
              "additionalProperties": false
            },
            "include_position": { "type": "boolean" },
            "render": {
              "type": "object",
              "properties": {
                "mermaid": { "type": "boolean" },
                "hide_start": { "type": "boolean" },
                "hide_end": { "type": "boolean" },
                "overview_subgraphs": { "type": "boolean" }
              },
              "additionalProperties": false
            }
          },
          "additionalProperties": false
        },
        "validate": {
          "type": "object",
          "description": "Validation AST + règles.",
          "properties": {
            "limit_steps": { "type": "integer", "minimum": 1, "maximum": 200, "default": 20 },
            "include_preflight": { "type": "boolean" },
            "strict_tools": { "type": "boolean" },
            "persist": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "limit": { "type": "integer", "minimum": 1, "maximum": 1000, "description": "Limite pour transforms listing" },
        "set": {
          "type": "object",
          "description": "Config writer (operation=config).",
          "properties": {
            "key": { "type": "string" },
            "key_path": { "type": "string" },
            "value": {
              "type": "string",
              "description": "Valeur JSON sérialisée (string). Exemples: \"true\", \"123\", \"\\\"hello\\\"\", \"{\\\"a\\\":1}\", \"[1,2,3]\""
            },
            "storage": { "type": "string", "enum": ["file", "inline"] },
            "file": { "type": "string" },
            "create": { "type": "boolean" }
          },
          "additionalProperties": false
        }
      },
      "required": ["operation"],
      "additionalProperties": false
    }
  }
}
