

{
  "id": "COLLECT",
  "version": "1.0",
  "description": "Multi-source collection (News, Reddit, arXiv, Sonar) + freshness filter (â‰¤72h)",
  
  "interface": {"entry": "dates_to_ymd", "exits": {"success": "exit_success", "fail": "exit_fail"}},
  
  "nodes": [
    {
      "name": "dates_to_ymd",
      "type": "transform",
      "handler": "date_ops",
      "inputs": {"ops": [
        {"op":"format","value":"${cycle.dates.from}","to":"YYYY-MM-DD","save_as":"from_ymd"},
        {"op":"format","value":"${cycle.dates.now}", "to":"YYYY-MM-DD","save_as":"now_ymd"}
      ]},
      "outputs": {"from_ymd":"cycle.dates.from_ymd","now_ymd":"cycle.dates.now_ymd"}
    },

    {
      "name": "fetch_news",
      "type": "io",
      "handler": "http_tool",
      "inputs": {
        "tool": "news_aggregator",
        "operation": "search_news",
        "query": "(AI OR \"artificial intelligence\" OR \"large language model\" OR LLM OR transformer) AND (OpenAI OR Anthropic OR Google OR DeepMind OR Meta OR NVIDIA OR Microsoft OR Gemini OR Claude OR GPT)",
        "from_date": "${cycle.dates.from_ymd}",
        "to_date": "${cycle.dates.now_ymd}",
        "providers": ["guardian"],
        "limit": 30
      },
      "outputs": {"articles": "cycle.sources.news"},
      "timeout_sec": 30,
      "retry": {"max": 2, "delay_sec": 2}
    },

    {
      "name": "fetch_reddit",
      "type": "io",
      "handler": "http_tool",
      "inputs": {
        "tool": "reddit_intelligence",
        "operation": "multi_search",
        "subreddits": ["MachineLearning", "LocalLLaMA", "OpenAI"],
        "query": "AI OR LLM OR transformer OR GPT OR Claude OR Gemini",
        "limit_per_sub": 10,
        "time_filter": "week"
      },
      "outputs": {"results": "cycle.sources.reddit"},
      "timeout_sec": 30,
      "retry": {"max": 2, "delay_sec": 2}
    },

    {
      "name": "fetch_arxiv",
      "type": "io",
      "handler": "http_tool",
      "inputs": {"tool": "academic_research_super", "operation": "search_papers", "sources": ["arxiv"], "query": "large language model OR transformer OR LLM", "include_abstracts": false, "year_from": 2025, "year_to": 2025, "max_results": 25},
      "outputs": {"results": "cycle.sources.arxiv"},
      "timeout_sec": 30,
      "retry": {"max": 2, "delay_sec": 2}
    },

    {
      "name": "fetch_sonar",
      "type": "io",
      "handler": "http_tool",
      "inputs": {"tool": "call_llm", "model": "sonar", "messages": {"$import": "../prompts/sonar_fetch.json"}, "temperature": 0.3},
      "outputs": {"content": "cycle.sources.sonar_raw"},
      "timeout_sec": 90,
      "retry": {"max": 2, "delay_sec": 5}
    },

    {"name": "normalize_sonar", "type": "transform", "handler": "normalize_llm_output", "inputs": {"content": "${cycle.sources.sonar_raw}"}, "outputs": {"parsed": "cycle.sources.sonar"}},

    {"name": "filter_news",   "type": "transform", "handler": "array_ops", "inputs": {"op":"filter","items":"${cycle.sources.news}",   "predicate":{"kind":"date_gte","path":"published_at","cutoff":"${cycle.dates.from}"}}, "outputs": {"items": "cycle.fresh.news",  "kept": "cycle.metrics.news_kept",  "dropped": "cycle.metrics.news_dropped"}},
    {"name": "filter_reddit", "type": "transform", "handler": "array_ops", "inputs": {"op":"filter","items":"${cycle.sources.reddit}", "predicate":{"kind":"date_gte","path":"created_utc","cutoff":"${cycle.dates.from}","unix":true}}, "outputs": {"items": "cycle.fresh.reddit", "kept": "cycle.metrics.reddit_kept", "dropped": "cycle.metrics.reddit_dropped"}},
    {"name": "filter_arxiv",  "type": "transform", "handler": "array_ops", "inputs": {"op":"filter","items":"${cycle.sources.arxiv}",  "predicate":{"kind":"date_gte","path":"publication_date","cutoff":"${cycle.dates.from}"}}, "outputs": {"items": "cycle.fresh.arxiv",  "kept": "cycle.metrics.arxiv_kept",  "dropped": "cycle.metrics.arxiv_dropped"}},
    {"name": "filter_sonar",  "type": "transform", "handler": "array_ops", "inputs": {"op":"filter","items":"${cycle.sources.sonar}",  "predicate":{"kind":"date_gte","path":"published_at","cutoff":"${cycle.dates.from}"}}, "outputs": {"items": "cycle.fresh.sonar",  "kept": "cycle.metrics.sonar_kept",  "dropped": "cycle.metrics.sonar_dropped"}},

    {"name": "compute_total_kept", "type": "io", "handler": "http_tool", "inputs": {"tool": "math", "operation": "eval", "expr": "${cycle.metrics.news_kept}+${cycle.metrics.reddit_kept}+${cycle.metrics.arxiv_kept}+${cycle.metrics.sonar_kept}"}, "outputs": {"result": "cycle.metrics.total_kept"}, "timeout_sec": 5},

    {"name": "has_data", "type": "decision", "decision": {"kind": "compare", "input": "${cycle.metrics.total_kept}", "operator": ">=", "value": 1}},
    {"name": "exit_success", "type": "transform", "handler": "set_value", "inputs": {"value": true}, "outputs": {"result": "cycle.result.has_data"}},
    {"name": "exit_fail", "type": "transform", "handler": "set_value", "inputs": {"value": false}, "outputs": {"result": "cycle.result.has_data"}}
  ],
  
  "edges": [
    {"from": "dates_to_ymd", "to": "fetch_news"},
    {"from": "fetch_news", "to": "fetch_reddit"},
    {"from": "fetch_reddit", "to": "fetch_arxiv"},
    {"from": "fetch_arxiv", "to": "fetch_sonar"},
    {"from": "fetch_sonar", "to": "normalize_sonar"},
    {"from": "normalize_sonar", "to": "filter_news"},
    {"from": "filter_news", "to": "filter_reddit"},
    {"from": "filter_reddit", "to": "filter_arxiv"},
    {"from": "filter_arxiv", "to": "filter_sonar"},
    {"from": "filter_sonar", "to": "compute_total_kept"},
    {"from": "compute_total_kept", "to": "has_data"},
    {"from": "has_data", "to": "exit_success", "when": "true"},
    {"from": "has_data", "to": "exit_fail", "when": "false"}
  ]
}
