{
  "id": "OUTPUT",
  "version": "1.0",
  "description": "Format final report in French + save to DB",
  
  "interface": {
    "entry": "llm_format_fr",
    "exits": {
      "success": "save_report"
    }
  },
  
  "nodes": [
    {
      "name": "llm_format_fr",
      "type": "io",
      "handler": "http_tool",
      "inputs": {
        "tool": "call_llm",
        "model": "${worker.llm_model}",
        "messages": {"$import": "../prompts/gpt_format_fr.json"},
        "temperature": 0.3
      },
      "outputs": {"content": "cycle.result.report_markdown"},
      "timeout_sec": 120,
      "retry": {"max": 2, "delay_sec": 5}
    },
    {
      "name": "get_completion_timestamp",
      "type": "io",
      "handler": "http_tool",
      "inputs": {"tool": "date", "operation": "now", "format": "iso", "timezone": "UTC"},
      "outputs": {"result": "cycle.result.completed_at", "content": "cycle.result.completed_at"},
      "timeout_sec": 5
    },
    {
      "name": "save_report",
      "type": "io",
      "handler": "http_tool",
      "inputs": {
        "tool": "sqlite_db",
        "operation": "execute",
        "db": "${worker.db_file}",
        "query": "INSERT INTO reports (date_from, date_to, report_markdown, avg_score, retry_count, top10_json, completed_at) VALUES (?, ?, ?, ?, ?, ?, ?)",
        "params": [
          "${cycle.dates.from}",
          "${cycle.dates.now}",
          "${cycle.result.report_markdown}",
          "${cycle.validation.score}",
          "${cycle.meta.retry_count}",
          "${cycle.scoring.top10_json}",
          "${cycle.result.completed_at}"
        ]
      },
      "outputs": {"success": "cycle.result.saved"},
      "timeout_sec": 15
    }
  ],
  
  "edges": [
    {"from": "llm_format_fr", "to": "get_completion_timestamp"},
    {"from": "get_completion_timestamp", "to": "save_report"}
  ]
}
