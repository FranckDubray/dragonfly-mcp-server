{
  "id": "ENRICH",
  "version": "1.0",
  "description": "Enrich Top10 items with primary sources (blogs/research/press/arXiv/news) â‰¤72h and store JSON per item",
  "interface": {
    "entry": "ensure_sources_table",
    "exits": { "success": "exit_enrich" }
  },
  "nodes": [
    {"name": "ensure_sources_table", "type": "io", "handler": "http_tool", "inputs": {"tool": "sqlite_db", "operation": "execute", "db": "${worker.db_file}", "query": "CREATE TABLE IF NOT EXISTS sources (id INTEGER PRIMARY KEY AUTOINCREMENT, report_from TEXT, report_to TEXT, item_index INTEGER, topic_title TEXT, sources_json TEXT, inserted_at TEXT)" }, "outputs": {"success": "cycle.enrich.table_ready"}, "timeout_sec": 10},

    {"name": "init_index", "type": "transform", "handler": "set_value", "inputs": {"value": 0}, "outputs": {"result": "cycle.enrich.i"}},

    {"name": "make_slice_skip", "type": "transform", "handler": "array_ops", "inputs": {"op": "skip", "items": "${cycle.scoring.top10}", "count": "${cycle.enrich.i}"}, "outputs": {"items": "cycle.enrich.slice"}},
    {"name": "take_one", "type": "transform", "handler": "array_ops", "inputs": {"op": "take", "items": "${cycle.enrich.slice}", "count": 1}, "outputs": {"items": "cycle.enrich.one"}},
    {"name": "get_item", "type": "transform", "handler": "json_ops", "inputs": {"op": "get", "data": "${cycle.enrich.one}", "path": "items[0]", "default": null}, "outputs": {"result": "cycle.enrich.item"}},

    {"name": "has_item", "type": "decision", "decision": {"kind": "truthy", "input": "${cycle.enrich.item}"}},

    {"name": "build_query", "type": "transform", "handler": "format_template", "inputs": {"template": "{{title}} official blog OR press OR research", "context": {"title": "${cycle.enrich.item.title}"}}, "outputs": {"result": "cycle.enrich.query"}},

    {"name": "search_primary", "type": "io", "handler": "http_tool", "inputs": {"tool": "universal_doc_scraper", "operation": "search_across_sites", "sites": "${worker.primary_sites}", "query": "${cycle.enrich.query}", "max_results": 5, "max_pages": 2}, "outputs": {"result": "cycle.enrich.primary"}, "timeout_sec": 20, "retry": {"max": 1, "delay_sec": 2}},

    {"name": "news_primary", "type": "io", "handler": "http_tool", "inputs": {"tool": "news_aggregator", "operation": "search_news", "providers": ["nyt","guardian"], "query": "${cycle.enrich.item.title}", "from_date": "${cycle.dates.from_ymd}", "to_date": "${cycle.dates.now_ymd}", "limit": 5}, "outputs": {"articles": "cycle.enrich.news"}, "timeout_sec": 20},

    {"name": "arxiv_primary", "type": "io", "handler": "http_tool", "inputs": {"tool": "academic_research_super", "operation": "search_papers", "sources": ["arxiv"], "query": "${cycle.enrich.item.title}", "include_abstracts": false, "max_results": 5}, "outputs": {"results": "cycle.enrich.arxiv"}, "timeout_sec": 20},

    {"name": "merge_sources", "type": "transform", "handler": "array_concat", "inputs": {"lists": ["${cycle.enrich.primary.results}", "${cycle.enrich.news}", "${cycle.enrich.arxiv}"]}, "outputs": {"items": "cycle.enrich.merged_all"}},

    {"name": "dedupe_sources", "type": "transform", "handler": "array_ops", "inputs": {"op": "unique_by", "items": "${cycle.enrich.merged_all}", "key": "url"}, "outputs": {"items": "cycle.enrich.merged"}},

    {"name": "json_stringify_sources", "type": "transform", "handler": "json_stringify", "inputs": {"value": "${cycle.enrich.merged}"}, "outputs": {"json_string": "cycle.enrich.sources_json"}},

    {"name": "insert_sources_row", "type": "io", "handler": "http_tool", "inputs": {"tool": "sqlite_db", "operation": "execute", "db": "${worker.db_file}", "query": "INSERT INTO sources (report_from, report_to, item_index, topic_title, sources_json, inserted_at) VALUES (?, ?, ?, ?, ?, ?)", "params": ["${cycle.dates.from}", "${cycle.dates.now}", "${cycle.enrich.i}", "${cycle.enrich.item.title}", "${cycle.enrich.sources_json}", "${cycle.validation.timestamp}"]}, "outputs": {"success": "cycle.enrich.inserted"}, "timeout_sec": 10},

    {"name": "inc_index", "type": "transform", "handler": "increment", "inputs": {"value": "${cycle.enrich.i}", "step": 1}, "outputs": {"result": "cycle.enrich.i"}},

    {"name": "exit_enrich", "type": "transform", "handler": "set_value", "inputs": {"value": true}, "outputs": {"result": "cycle.enrich.done"}}
  ],
  "edges": [
    {"from": "ensure_sources_table", "to": "init_index"},
    {"from": "init_index", "to": "make_slice_skip"},
    {"from": "make_slice_skip", "to": "take_one"},
    {"from": "take_one", "to": "get_item"},
    {"from": "get_item", "to": "has_item"},
    {"from": "has_item", "to": "build_query", "when": "true"},
    {"from": "has_item", "to": "exit_enrich", "when": "false"},

    {"from": "build_query", "to": "search_primary"},
    {"from": "search_primary", "to": "news_primary"},
    {"from": "news_primary", "to": "arxiv_primary"},
    {"from": "arxiv_primary", "to": "merge_sources"},
    {"from": "merge_sources", "to": "dedupe_sources"},
    {"from": "dedupe_sources", "to": "json_stringify_sources"},
    {"from": "json_stringify_sources", "to": "insert_sources_row"},
    {"from": "insert_sources_row", "to": "make_slice_skip"},

    {"from": "exit_enrich", "to": "exit_enrich"}
  ]
}
