{
  "id": "VALIDATE",
  "version": "1.0",
  "description": "Quality validation with Sonar (retry loop until score â‰¥${worker.quality_threshold} or max ${worker.max_retries} attempts)",
  "interface": {
    "entry": "get_validation_timestamp",
    "exits": {
      "success": "validate_exit_success",
      "retry": "validate_exit_retry",
      "retry_exhausted": "validate_exit_retry_exhausted"
    }
  },
  "nodes": [
    {"name": "get_validation_timestamp", "type": "io", "handler": "http_tool", "inputs": {"tool": "date", "operation": "now", "format": "iso", "timezone": "UTC"}, "outputs": {"result": "cycle.validation.timestamp", "content": "cycle.validation.timestamp"}, "timeout_sec": 5},
    {"name": "llm_sonar_validate", "type": "io", "handler": "http_tool", "inputs": {"tool": "call_llm", "model": "${worker.sonar_model}", "messages": {"$import": "../prompts/sonar_validation.json"}, "temperature": 0.1, "response_format": "json", "require_keys": ["content"]}, "outputs": {"content": "cycle.validation.raw"}, "timeout_sec": 90, "retry": {"max": 2, "delay_sec": 5}},

    {"name": "normalize_sonar_validation", "type": "transform", "handler": "normalize_llm_output", "inputs": {"content": "${cycle.validation.raw}"}, "outputs": {"parsed": "cycle.validation.parsed"}},
    {"name": "stringify_parsed", "type": "transform", "handler": "json_stringify", "inputs": {"value": "${cycle.validation.parsed}"}, "outputs": {"json_string": "cycle.validation.debug_parsed"}},

    {"name": "extract_score_raw", "type": "transform", "handler": "json_ops", "inputs": {"op": "get", "data": "${cycle.validation.parsed}", "path": "score", "default": null}, "outputs": {"result": "cycle.validation.score_raw"}},
    {"name": "has_score_raw", "type": "decision", "decision": {"kind": "truthy", "input": "${cycle.validation.score_raw}"}},
    {"name": "extract_score_alt", "type": "transform", "handler": "json_ops", "inputs": {"op": "get", "data": "${cycle.validation.parsed}", "path": "result.score", "default": null}, "outputs": {"result": "cycle.validation.score_raw"}},

    {"name": "stringify_score_raw", "type": "transform", "handler": "json_stringify", "inputs": {"value": "${cycle.validation.score_raw}"}, "outputs": {"json_string": "cycle.validation.debug_score_raw"}},
    {"name": "normalize_score", "type": "transform", "handler": "coerce_number", "inputs": {"value": "${cycle.validation.score_raw}", "default": 0.0}, "outputs": {"number": "cycle.validation.score"}},

    {"name": "extract_feedback", "type": "transform", "handler": "json_ops", "inputs": {"op": "get", "data": "${cycle.validation.parsed}", "path": "feedback", "default": "No feedback"}, "outputs": {"result": "cycle.validation.feedback"}},
    {"name": "insert_validation_log", "type": "io", "handler": "http_tool", "inputs": {"tool": "sqlite_db", "operation": "execute", "db": "${worker.db_file}", "query": "INSERT INTO validation_logs (timestamp, attempt, score, feedback, top10_json) VALUES (?, ?, ?, ?, ?)", "params": ["${cycle.validation.timestamp}", "${cycle.meta.retry_count}", "${cycle.validation.score}", "${cycle.validation.feedback}", "${cycle.scoring.top10_json}"]}, "outputs": {"success": "cycle.validation.logged"}, "timeout_sec": 10},

    {"name": "load_threshold", "type": "transform", "handler": "set_value", "inputs": {"value": "${worker.quality_threshold}"}, "outputs": {"result": "cycle.validation.threshold"}},

    {"name": "check_score_threshold", "type": "decision", "decision": {"kind": "compare", "input": "${cycle.validation.score}", "operator": ">=", "value": "${cycle.validation.threshold}"}},
    {"name": "increment_retry", "type": "transform", "handler": "increment", "inputs": {"value": "${cycle.meta.retry_count}", "step": 1}, "outputs": {"result": "cycle.meta.retry_count"}},
    {"name": "check_retry_limit", "type": "decision", "decision": {"kind": "compare", "input": "${cycle.meta.retry_count}", "operator": "<", "value": "${worker.max_retries}"}},

    {"name": "format_validation_log_message_success", "type": "transform", "handler": "format_template", "inputs": {"template": "Score: {{score}}/10 | Tentatives: {{retry_count}} | Feedback: {{feedback}}", "context": {"score": "${cycle.validation.score}", "retry_count": "${cycle.meta.retry_count}", "feedback": "${cycle.validation.feedback}"}}, "outputs": {"result": "cycle.validation.log_message"}},

    {"name": "format_validation_log_message_exhausted", "type": "transform", "handler": "format_template", "inputs": {"template": "Score: {{score}}/10 | Tentatives: {{retry_count}} | Feedback: {{feedback}}", "context": {"score": "${cycle.validation.score}", "retry_count": "${cycle.meta.retry_count}", "feedback": "${cycle.validation.feedback}"}}, "outputs": {"result": "cycle.validation.log_message"}},

    {"name": "validate_exit_success", "type": "transform", "handler": "set_value", "inputs": {"value": true}},
    {"name": "validate_exit_retry", "type": "transform", "handler": "set_value", "inputs": {"value": true}},
    {"name": "validate_exit_retry_exhausted", "type": "transform", "handler": "set_value", "inputs": {"value": true}}
  ],
  "edges": [
    {"from": "get_validation_timestamp", "to": "llm_sonar_validate"},
    {"from": "llm_sonar_validate", "to": "normalize_sonar_validation"},
    {"from": "normalize_sonar_validation", "to": "stringify_parsed"},

    {"from": "stringify_parsed", "to": "extract_score_raw"},
    {"from": "extract_score_raw", "to": "has_score_raw"},
    {"from": "has_score_raw", "to": "stringify_score_raw", "when": "true"},
    {"from": "has_score_raw", "to": "extract_score_alt", "when": "false"},
    {"from": "extract_score_alt", "to": "stringify_score_raw"},

    {"from": "stringify_score_raw", "to": "normalize_score"},
    {"from": "normalize_score", "to": "extract_feedback"},
    {"from": "extract_feedback", "to": "insert_validation_log"},
    {"from": "insert_validation_log", "to": "load_threshold"},
    {"from": "load_threshold", "to": "check_score_threshold"},

    {"from": "check_score_threshold", "to": "format_validation_log_message_success", "when": "true"},
    {"from": "format_validation_log_message_success", "to": "validate_exit_success"},

    {"from": "check_score_threshold", "to": "increment_retry", "when": "false"},
    {"from": "increment_retry", "to": "check_retry_limit"},
    {"from": "check_retry_limit", "to": "validate_exit_retry", "when": "true"},
    {"from": "check_retry_limit", "to": "format_validation_log_message_exhausted", "when": "false"},
    {"from": "format_validation_log_message_exhausted", "to": "validate_exit_retry_exhausted"}
  ]
}
