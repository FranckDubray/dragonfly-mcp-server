{
  "id": "GAME_LOOP",
  "version": "1.1",
  "description": "Turn timer + wand handle + move detect + validate + engine; routes to sanction or loops (owner-only, case_size=3)",
  "interface": { "entry": "LOOP_START", "exits": { "done": "LOOP_EXIT_DONE", "sanction": "LOOP_EXIT_SANCTION" } },
  "nodes": [
    { "name": "LOOP_START", "type": "transform", "handler": "set_value", "inputs": {"value": true} },

    { "name": "TMR_GET_NOW",  "type": "io", "handler": "http_tool", "inputs": {"tool":"date","operation":"now","format":"iso","timezone":"UTC"}, "outputs": {"result":"timer.now"} },
    { "name": "TMR_GET_LAST", "type": "transform", "handler": "json_ops", "inputs": {"op":"get","data":"${game}","path":"last_turn_ts","default": null}, "outputs": {"result":"timer.last"} },
    { "name": "TMR_DIFF",     "type": "transform", "handler": "date_ops", "inputs": {"ops":[{"op":"diff","a":"${timer.now}","b":"${timer.last}","unit":"seconds","save_as":"elapsed"}]}, "outputs": {"elapsed":"timer.elapsed_s"} },
    { "name": "TMR_DECIDE",   "type": "decision", "decision": {"kind":"compare","input":"${timer.elapsed_s}","operator":">","value":"${worker.turns.max_seconds}"} },

    { "name": "WH_READ_CLICKS", "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"execute as @a[tag=chess_owner] run scoreboard players get @s wand_uses"}, "outputs": {"result":"wand.uses_line"} },
    { "name": "WH_PARSE_CLICKS", "type": "transform", "handler": "coerce_number", "inputs": {"value":"${wand.uses_line}"}, "outputs": {"number":"wand.uses_now"} },
    { "name": "WH_DEC_CLICK", "type": "decision", "decision": {"kind":"compare","input":"${wand.uses_now}","operator":">","value":"${wand.uses_prev}"} },
    { "name": "WH_SLEEP_IDLE", "type": "transform", "handler": "sleep", "inputs": {"ms":300} },

    { "name": "WH_MSG_CHALLENGE", "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"title @a[tag=chess_owner] actionbar {\"text\":\"Defi aux echecs\",\"color\":\"yellow\"}"} },
    { "name": "WH_CHECK_SEL",     "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"execute as @a[tag=chess_owner] run scoreboard players get @s wand_state"}, "outputs": {"result":"wand.state_line"} },
    { "name": "WH_DEC_SEL",       "type": "decision", "decision": {"kind":"regex","input":"${wand.state_line}","pattern":".*\\s1$"} },

    { "name": "WH_SELECT",     "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"batch_commands","delay_ms":10,"commands": {"$import":"workers/minecraft_stockfish/scripts/mc/select_raycast_1_6_owner_color.cmds.txt"}} },
    { "name": "WH_DEC_TARGET", "type": "decision", "decision": {"kind":"compare","input":"${wand.state_line}","operator":">=","value":0} },
    { "name": "WH_MSG_NOTARGET", "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"title @a[tag=chess_owner] actionbar {\"text\":\"Aucune piece\",\"color\":\"red\"}"} },
    { "name": "WH_SLEEP_NOTARGET", "type": "transform", "handler": "sleep", "inputs": {"ms":300} },
    { "name": "WH_STORE_USES_NT", "type": "transform", "handler": "set_value", "inputs": {"value":"${wand.uses_now}"}, "outputs": {"result":"wand.uses_prev"} },
    { "name": "WH_STORE_USES_SEL", "type": "transform", "handler": "set_value", "inputs": {"value":"${wand.uses_now}"}, "outputs": {"result":"wand.uses_prev"} },

    { "name": "DROP_PREP",    "type": "transform", "handler": "json_ops", "inputs": {"op":"set","data":{},"set_values":{}}, "outputs": {} },
    { "name": "DROP_DEC_CAP", "type": "decision", "decision": {"kind":"truthy","input": false} },
    { "name": "DROP_DO",      "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"batch_commands","delay_ms":0,"commands": {"$import":"workers/minecraft_stockfish/scripts/mc/drop_capture_and_snap.cmds.txt"}} },
    { "name": "WH_SLEEP_DROP", "type": "transform", "handler": "sleep", "inputs": {"ms":200} },
    { "name": "WH_STORE_USES_DROP", "type": "transform", "handler": "set_value", "inputs": {"value":"${wand.uses_now}"}, "outputs": {"result":"wand.uses_prev"} },

    { "name": "MP_ENTRY",   "type": "transform", "handler": "set_value", "inputs": {"value": true} },
    { "name": "MD_LIST",    "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"list_entities","selector":"@e[tag=chess_piece]","fields":["uuid","custom_name","pos","tags"],"limit":64}, "outputs": {"result":"mc.raw"} },
    { "name": "MD_NORM",    "type": "transform", "handler": "normalize_entities", "inputs": {"items":"${mc.raw}"}, "outputs": {"items":"mc.norm"} },
    { "name": "MD_SORT",    "type": "transform", "handler": "array_ops", "inputs": {"op":"sort_by","items":"${mc.norm}","key":"pos.y","order":"desc"}, "outputs": {"items":"mc.sorted"} },
    { "name": "MD_UNIQ",    "type": "transform", "handler": "array_ops", "inputs": {"op":"unique_by","items":"${mc.sorted}","key":"piece_key"}, "outputs": {"items":"mc.dedup"} },
    { "name": "MD_SNAP",    "type": "transform", "handler": "pos_to_square", "inputs": {"items":"${mc.dedup}","origin":"${worker.chess.origin_center}","axis":"${worker.chess.axis}","case_size":"${worker.chess.case_size}","epsilon":"${worker.chess.epsilon_snap}"}, "outputs": {"map":"curr.positions"} },
    { "name": "MD_CMP",     "type": "transform", "handler": "compare_positions", "inputs": {"prev":"${prev.positions}","curr":"${curr.positions}"}, "outputs": {"unique":"move.unique","piece_key":"move.piece_key","from":"move.from","to":"move.to"} },
    { "name": "MD_DEC_UNIQUE", "type": "decision", "decision": {"kind":"truthy","input":"${move.unique}"} },
    { "name": "MP_SLEEP",   "type": "transform", "handler": "sleep", "inputs": {"ms":300} },
    { "name": "MD_SET_PREV","type": "transform", "handler": "set_value", "inputs": {"value":"${curr.positions}"}, "outputs": {"result":"prev.positions"} },
    { "name": "MD_UCI",     "type": "transform", "handler": "uci_build", "inputs": {"from":"${move.from}","to":"${move.to}","piece_letter":"${move.letter}"}, "outputs": {"uci":"move.uci"} },

    { "name": "VP_BEFORE",  "type": "io", "handler": "http_tool", "inputs": {"tool":"stockfish_auto","operation":"evaluate_position","position":{"startpos":true,"moves":"${game.moves}"},"quality":"${worker.stockfish.quality}","limit":"${worker.stockfish.limit}"}, "outputs": {"result":"sf.before"} },
    { "name": "VP_AFTER",   "type": "io", "handler": "http_tool", "inputs": {"tool":"stockfish_auto","operation":"evaluate_position","position":{"startpos":true,"moves":"${game.moves} ${move.uci}"},"quality":"${worker.stockfish.quality}","limit":"${worker.stockfish.limit}"}, "outputs": {"result":"sf.after"} },

    { "name": "VB_BEFORE_CP", "type": "transform", "handler": "json_ops", "inputs": {"op":"get","data":"${sf.before}","path":"result.lines.0.score.value","default":0}, "outputs": {"result":"sf.before_cp_raw"} },
    { "name": "VB_AFTER_CP",  "type": "transform", "handler": "json_ops", "inputs": {"op":"get","data":"${sf.after}","path":"result.lines.0.score.value","default":0}, "outputs": {"result":"sf.after_cp_raw"} },
    { "name": "VB_BEFORE_CP_NUM", "type": "transform", "handler": "coerce_number", "inputs": {"value":"${sf.before_cp_raw}"}, "outputs": {"number":"sf.before_cp"} },
    { "name": "VB_AFTER_CP_NUM",  "type": "transform", "handler": "coerce_number", "inputs": {"value":"${sf.after_cp_raw}"}, "outputs": {"number":"sf.after_cp"} },
    { "name": "VB_DELTA",    "type": "transform", "handler": "add", "inputs": {"a":"${sf.after_cp}", "b":"- ${sf.before_cp}"}, "outputs": {"result":"sf.delta_cp"} },
    { "name": "VP_DEC_BAD",  "type": "decision", "decision": {"kind":"compare","input":"${sf.delta_cp}","operator":"<","value":"${worker.turns.bad_move_threshold_cp}"} },

    { "name": "GAME_PUSH_MOVE", "type": "transform", "handler": "set_value", "inputs": {"value":"${game.moves} ${move.uci}"}, "outputs": {"result":"game.moves"} },

    { "name": "BM_REQ",     "type": "io", "handler": "http_tool", "inputs": {"tool":"stockfish_auto","operation":"evaluate_position","position":{"startpos":true,"moves":"${game.moves}"},"quality":"${worker.stockfish.quality}","limit":"${worker.stockfish.limit}"}, "outputs": {"result":"sf.best"} },
    { "name": "BM_PARSE",   "type": "transform", "handler": "json_ops", "inputs": {"op":"get","data":"${sf.best}","path":"bestmove.move","default":""}, "outputs": {"result":"sf.best_uci"} },
    { "name": "GAME_PUSH_BLACK", "type": "transform", "handler": "set_value", "inputs": {"value":"${game.moves} ${sf.best_uci}"}, "outputs": {"result":"game.moves"} },

    { "name": "AB_PREP",    "type": "transform", "handler": "json_ops", "inputs": {"op":"set","data":{},"set_values":{}}, "outputs": {} },
    { "name": "AB_ANIM",    "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"batch_commands","delay_ms":50,"commands": {"$import":"workers/minecraft_stockfish/scripts/mc/animate_tp_steps_snap_center.cmds.txt"}} },
    { "name": "AB_MSG",     "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"title @a[tag=chess_owner] actionbar {\"text\":\"Coup noir joue\",\"color\":\"green\"}"} },
    { "name": "ET_SLEEP",   "type": "transform", "handler": "sleep", "inputs": {"ms":200} },
    { "name": "TT_STORE_END","type": "transform", "handler": "set_value", "inputs": {"value":"${timer.now}"}, "outputs": {"result":"game.last_turn_ts"} },

    { "name": "LOOP_EXIT_DONE",     "type": "transform", "handler": "set_value", "inputs": {"value": true} },
    { "name": "LOOP_EXIT_SANCTION", "type": "transform", "handler": "set_value", "inputs": {"value": true} },

    { "name": "GL_TO_SANCTION", "type": "transform", "handler": "set_value", "inputs": {"value": true} }
  ],
  "edges": [
    {"from":"LOOP_START","to":"TMR_GET_NOW"},
    {"from":"TMR_GET_NOW","to":"TMR_GET_LAST"},
    {"from":"TMR_GET_LAST","to":"TMR_DIFF"},
    {"from":"TMR_DIFF","to":"TMR_DECIDE"},
    {"from":"TMR_DECIDE","to":"LOOP_EXIT_SANCTION","when":"true"},
    {"from":"TMR_DECIDE","to":"WH_READ_CLICKS","when":"false"},

    {"from":"WH_READ_CLICKS","to":"WH_PARSE_CLICKS"},
    {"from":"WH_PARSE_CLICKS","to":"WH_DEC_CLICK"},
    {"from":"WH_DEC_CLICK","to":"WH_SLEEP_IDLE","when":"false"},
    {"from":"WH_SLEEP_IDLE","to":"TMR_GET_NOW"},
    {"from":"WH_DEC_CLICK","to":"WH_MSG_CHALLENGE","when":"true"},
    {"from":"WH_MSG_CHALLENGE","to":"WH_CHECK_SEL"},
    {"from":"WH_CHECK_SEL","to":"WH_DEC_SEL"},

    {"from":"WH_DEC_SEL","to":"WH_SELECT","when":"false"},
    {"from":"WH_SELECT","to":"WH_DEC_TARGET"},
    {"from":"WH_DEC_TARGET","to":"WH_MSG_NOTARGET","when":"false"},
    {"from":"WH_MSG_NOTARGET","to":"WH_SLEEP_NOTARGET"},
    {"from":"WH_SLEEP_NOTARGET","to":"WH_STORE_USES_NT"},
    {"from":"WH_STORE_USES_NT","to":"TMR_GET_NOW"},
    {"from":"WH_DEC_TARGET","to":"WH_STORE_USES_SEL","when":"true"},
    {"from":"WH_STORE_USES_SEL","to":"TMR_GET_NOW"},

    {"from":"WH_DEC_SEL","to":"DROP_PREP","when":"true"},
    {"from":"DROP_PREP","to":"DROP_DEC_CAP"},
    {"from":"DROP_DEC_CAP","to":"DROP_DO","when":"false"},
    {"from":"DROP_DO","to":"WH_SLEEP_DROP"},
    {"from":"WH_SLEEP_DROP","to":"WH_STORE_USES_DROP"},
    {"from":"WH_STORE_USES_DROP","to":"MP_ENTRY"},
    {"from":"DROP_DEC_CAP","to":"DROP_DEC_COLOR","when":"true"},
    {"from":"DROP_DEC_COLOR","to":"DROP_MSG_WHITE","when":"true"},
    {"from":"DROP_MSG_WHITE","to":"DROP_KILL"},
    {"from":"DROP_DEC_COLOR","to":"DROP_MSG_BLACK","when":"false"},
    {"from":"DROP_MSG_BLACK","to":"DROP_KILL"},
    {"from":"DROP_KILL","to":"DROP_DO"},

    {"from":"MP_ENTRY","to":"MD_LIST"},
    {"from":"MD_LIST","to":"MD_NORM"},
    {"from":"MD_NORM","to":"MD_SORT"},
    {"from":"MD_SORT","to":"MD_UNIQ"},
    {"from":"MD_UNIQ","to":"MD_SNAP"},
    {"from":"MD_SNAP","to":"MD_CMP"},
    {"from":"MD_CMP","to":"MD_DEC_UNIQUE"},
    {"from":"MD_DEC_UNIQUE","to":"MP_SLEEP","when":"false"},
    {"from":"MP_SLEEP","to":"TMR_GET_NOW"},
    {"from":"MD_DEC_UNIQUE","to":"MD_SET_PREV","when":"true"},
    {"from":"MD_SET_PREV","to":"MD_UCI"},
    {"from":"MD_UCI","to":"VP_BEFORE"},

    {"from":"VP_BEFORE","to":"VP_AFTER"},
    {"from":"VP_AFTER","to":"VB_BEFORE_CP"},
    {"from":"VB_BEFORE_CP","to":"VB_AFTER_CP"},
    {"from":"VB_AFTER_CP","to":"VB_BEFORE_CP_NUM"},
    {"from":"VB_BEFORE_CP_NUM","to":"VB_AFTER_CP_NUM"},
    {"from":"VB_AFTER_CP_NUM","to":"VB_DELTA"},
    {"from":"VB_DELTA","to":"VP_DEC_BAD"},

    {"from":"VP_DEC_BAD","to":"GL_TO_SANCTION","when":"true"},
    {"from":"VP_DEC_BAD","to":"GAME_PUSH_MOVE","when":"false"},

    {"from":"GAME_PUSH_MOVE","to":"BM_REQ"},
    {"from":"BM_REQ","to":"BM_PARSE"},
    {"from":"BM_PARSE","to":"GAME_PUSH_BLACK"},
    {"from":"GAME_PUSH_BLACK","to":"AB_PREP"},
    {"from":"AB_PREP","to":"AB_ANIM"},
    {"from":"AB_ANIM","to":"AB_MSG"},
    {"from":"AB_MSG","to":"ET_SLEEP"},
    {"from":"ET_SLEEP","to":"TT_STORE_END"},
    {"from":"TT_STORE_END","to":"TMR_GET_NOW"},

    {"from":"GL_TO_SANCTION","to":"LOOP_EXIT_SANCTION"}
  ]
}
