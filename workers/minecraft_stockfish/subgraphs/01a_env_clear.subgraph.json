{
  "id": "ENV_CLEAR",
  "version": "1.0",
  "description": "Environment + Full-area clear + Entity purge (dynamic from worker config)",
  "interface": { "entry": "INIT_ENV", "exits": { "success": "DO_KILL_ZERO" } },
  "nodes": [
    { "name": "INIT_ENV",     "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"set_environment","weather":"${worker.env.weather}","time":"${worker.env.time}","difficulty":"${worker.env.difficulty}"} },

    { "name": "CLR_X1", "type": "transform", "handler": "add", "inputs": {"a":"${worker.chess.origin_center.x}", "b": -50 }, "outputs": {"result": "cycle.clear.x1"} },
    { "name": "CLR_X2", "type": "transform", "handler": "add", "inputs": {"a":"${worker.chess.origin_center.x}", "b": 50 },  "outputs": {"result": "cycle.clear.x2"} },
    { "name": "CLR_Z1", "type": "transform", "handler": "add", "inputs": {"a":"${worker.chess.origin_center.z}", "b": -50 }, "outputs": {"result": "cycle.clear.z1"} },
    { "name": "CLR_Z2", "type": "transform", "handler": "add", "inputs": {"a":"${worker.chess.origin_center.z}", "b": 50 },  "outputs": {"result": "cycle.clear.z2"} },
    { "name": "CLR_Y1", "type": "transform", "handler": "add", "inputs": {"a":"${worker.chess.y_level}", "b": -5 },  "outputs": {"result": "cycle.clear.y1"} } ,
    { "name": "CLR_Y2", "type": "transform", "handler": "add", "inputs": {"a":"${worker.chess.y_level}", "b": 4 },   "outputs": {"result": "cycle.clear.y2"} },

    { "name": "FT_CLEAR_BIG",  "type": "transform", "handler": "format_template",
      "inputs": {"template": "fill {{x1}} {{y1}} {{z1}} {{x2}} {{y2}} {{z2}} minecraft:air",
                  "context": {"x1": "${cycle.clear.x1}", "y1": "${cycle.clear.y1}", "z1": "${cycle.clear.z1}",
                               "x2": "${cycle.clear.x2}", "y2": "${cycle.clear.y2}", "z2": "${cycle.clear.z2}"}},
      "outputs": {"result": "cycle.mc.clear.cmd"}
    },
    { "name": "DO_CLEAR_BIG", "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"${cycle.mc.clear.cmd}"} },

    { "name": "DEC_DX", "type": "transform", "handler": "decrement", "inputs": {"value":"${cycle.clear.x2}", "step":"${cycle.clear.x1}"}, "outputs": {"result":"cycle.clear.dx"} },
    { "name": "DEC_DY", "type": "transform", "handler": "decrement", "inputs": {"value":"${cycle.clear.y2}", "step":"${cycle.clear.y1}"}, "outputs": {"result":"cycle.clear.dy"} },
    { "name": "DEC_DZ", "type": "transform", "handler": "decrement", "inputs": {"value":"${cycle.clear.z2}", "step":"${cycle.clear.z1}"}, "outputs": {"result":"cycle.clear.dz"} },

    { "name": "FT_KILL_BIG",  "type": "transform", "handler": "format_template",
      "inputs": {"template": "kill @e[type=!player,x={{x1}},y={{y1}},z={{z1}},dx={{dx}},dy={{dy}},dz={{dz}}]",
                  "context": {"x1": "${cycle.clear.x1}", "y1": "${cycle.clear.y1}", "z1": "${cycle.clear.z1}",
                               "dx": "${cycle.clear.dx}", "dy": "${cycle.clear.dy}", "dz": "${cycle.clear.dz}"}},
      "outputs": {"result": "cycle.mc.clear.kill_cmd"}
    },
    { "name": "DO_KILL_BIG", "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"${cycle.mc.clear.kill_cmd}"} },

    { "name": "FT_CLEAR_ZERO",  "type": "transform", "handler": "format_template",
      "inputs": {"template": "fill {{x1}} -10 {{z1}} {{x2}} 10 {{z2}} minecraft:air",
                  "context": {"x1": "${cycle.clear.x1}", "z1": "${cycle.clear.z1}",
                               "x2": "${cycle.clear.x2}", "z2": "${cycle.clear.z2}"}},
      "outputs": {"result": "cycle.mc.clear0.cmd"}
    },
    { "name": "DO_CLEAR_ZERO", "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"${cycle.mc.clear0.cmd}"} },

    { "name": "FT_KILL_ZERO",  "type": "transform", "handler": "format_template",
      "inputs": {"template": "kill @e[type=!player,x={{x1}},y=-10,z={{z1}},dx={{dx}},dy=20,dz={{dz}}]",
                  "context": {"x1": "${cycle.clear.x1}", "z1": "${cycle.clear.z1}",
                               "dx": "${cycle.clear.dx}", "dz": "${cycle.clear.dz}"}},
      "outputs": {"result": "cycle.mc.clear0.kill_cmd"}
    },
    { "name": "DO_KILL_ZERO", "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"${cycle.mc.clear0.kill_cmd}"} }
  ],
  "edges": [
    {"from":"INIT_ENV","to":"CLR_X1"},
    {"from":"CLR_X1","to":"CLR_X2"},
    {"from":"CLR_X2","to":"CLR_Z1"},
    {"from":"CLR_Z1","to":"CLR_Z2"},
    {"from":"CLR_Z2","to":"CLR_Y1"},
    {"from":"CLR_Y1","to":"CLR_Y2"},
    {"from":"CLR_Y2","to":"FT_CLEAR_BIG"},
    {"from":"FT_CLEAR_BIG","to":"DO_CLEAR_BIG"},

    {"from":"DO_CLEAR_BIG","to":"DEC_DX"},
    {"from":"DEC_DX","to":"DEC_DY"},
    {"from":"DEC_DY","to":"DEC_DZ"},
    {"from":"DEC_DZ","to":"FT_KILL_BIG"},
    {"from":"FT_KILL_BIG","to":"DO_KILL_BIG"},

    {"from":"DO_KILL_BIG","to":"FT_CLEAR_ZERO"},
    {"from":"FT_CLEAR_ZERO","to":"DO_CLEAR_ZERO"},

    {"from":"DO_CLEAR_ZERO","to":"FT_KILL_ZERO"},
    {"from":"FT_KILL_ZERO","to":"DO_KILL_ZERO"}
  ]
}
