{
  "id": "GI_SPAWN_LOCK_SNAP",
  "version": "1.4",
  "description": "Spawn 32 white animals on initial chess positions with camp-based orientation (white vs black), lock entities, then snapshot prev.positions. Idempotent: skip spawn if pieces already exist in board AABB.",
  "interface": { "entry": "SPAWN_START", "exits": { "done": "SNAP_DONE" } },
  "nodes": [
    { "name": "SPAWN_START", "type": "transform", "handler": "set_value", "inputs": {"value": true} },

    { "name": "CHECK_EXISTING", "type": "io", "handler": "http_tool",
      "inputs": {
        "tool": "minecraft_control",
        "operation": "list_entities",
        "selector": "@e[tag=chess_piece]",
        "area": {"mode": "aabb", "aabb": {"min": {"x": "${cycle.plat.x1}", "y": "${worker.chess.y_level - 1}", "z": "${cycle.plat.z1}"}, "max": {"x": "${cycle.plat.x2}", "y": "${worker.chess.y_level + 3}", "z": "${cycle.plat.z2}"}}},
        "fields": ["uuid", "pos", "tags"],
        "limit": 128
      },
      "outputs": {"result": "cycle.spawn.existing"}
    },
    { "name": "HAS_EXISTING", "type": "decision", "decision": {"kind": "truthy", "input": "${cycle.spawn.existing}"} },

    { "name": "SET_WHITE_SQUARES", "type": "transform", "handler": "set_value",
      "inputs": {"value": ["a1","b1","c1","d1","e1","f1","g1","h1","a2","b2","c2","d2","e2","f2","g2","h2"]},
      "outputs": {"result": "cycle.spawn.white_squares"}
    },
    { "name": "SET_BLACK_SQUARES", "type": "transform", "handler": "set_value",
      "inputs": {"value": ["a7","b7","c7","d7","e7","f7","g7","h7","a8","b8","c8","d8","e8","f8","g8","h8"]},
      "outputs": {"result": "cycle.spawn.black_squares"}
    },

    { "name": "FILTER_WHITE", "type": "transform", "handler": "array_ops",
      "inputs": {"op": "filter", "items": "${cycle.mc.board.squares}", "predicate": {"kind": "in_list", "path": "square", "list": "${cycle.spawn.white_squares}"}},
      "outputs": {"items": "cycle.spawn.white_items"}
    },
    { "name": "FILTER_BLACK", "type": "transform", "handler": "array_ops",
      "inputs": {"op": "filter", "items": "${cycle.mc.board.squares}", "predicate": {"kind": "in_list", "path": "square", "list": "${cycle.spawn.black_squares}"}},
      "outputs": {"items": "cycle.spawn.black_items"}
    },

    { "name": "TPL_WHITE_SUMMON", "type": "transform", "handler": "template_map",
      "inputs": {
        "items": "${cycle.spawn.white_items}",
        "template": "summon minecraft:sheep {{center.x}} {{center.y + 1.2}} {{center.z}} {NoAI:1b,NoGravity:1b,Invulnerable:1b,PersistenceRequired:1b,Color:0b,Rotation:[{{yaw}}f,0f],Tags:[\\\"chess_piece\\\",\\\"{{camp}}\\\",\\\"{{square}}\\\"]}",
        "globals": {"camp": "w", "yaw": 0},
        "round_coords": true
      },
      "outputs": {"commands": "cycle.spawn.white_cmds"}
    },
    { "name": "DO_SUMMONS_WHITE", "type": "io", "handler": "http_tool",
      "inputs": {"tool": "minecraft_control", "operation": "batch_commands", "delay_ms": 2, "commands": "${cycle.spawn.white_cmds}"}
    },

    { "name": "TPL_BLACK_SUMMON", "type": "transform", "handler": "template_map",
      "inputs": {
        "items": "${cycle.spawn.black_items}",
        "template": "summon minecraft:sheep {{center.x}} {{center.y + 1.2}} {{center.z}} {NoAI:1b,NoGravity:1b,Invulnerable:1b,PersistenceRequired:1b,Color:0b,Rotation:[{{yaw}}f,0f],Tags:[\\\"chess_piece\\\",\\\"{{camp}}\\\",\\\"{{square}}\\\"]}",
        "globals": {"camp": "b", "yaw": 180},
        "round_coords": true
      },
      "outputs": {"commands": "cycle.spawn.black_cmds"}
    },
    { "name": "DO_SUMMONS_BLACK", "type": "io", "handler": "http_tool",
      "inputs": {"tool": "minecraft_control", "operation": "batch_commands", "delay_ms": 2, "commands": "${cycle.spawn.black_cmds}"}
    },

    { "name": "INIT_LOCK", "type": "io", "handler": "http_tool", "inputs": {"tool": "minecraft_control", "operation": "execute_command", "command": "execute as @e[tag=chess_piece] run data merge entity @s {NoAI:1b,NoGravity:1b,Invulnerable:1b,PersistenceRequired:1b}"} },

    { "name": "LIST_INIT", "type": "io", "handler": "http_tool", "inputs": {"tool": "minecraft_control", "operation": "list_entities", "selector": "@e[tag=chess_piece]", "fields": ["uuid", "custom_name", "pos", "tags"], "limit": 128}, "outputs": {"result": "cycle.mc.raw"} },
    { "name": "NORM_INIT", "type": "transform", "handler": "normalize_entities", "inputs": {"items": "${cycle.mc.raw}"}, "outputs": {"items": "cycle.mc.norm"} },
    { "name": "STABLE_INIT", "type": "transform", "handler": "json_ops", "inputs": {"op": "set", "data": "${cycle.mc.norm}", "set_values": {}}, "outputs": {} },
    { "name": "SORT_INIT", "type": "transform", "handler": "array_ops", "inputs": {"op": "sort_by", "items": "${cycle.mc.norm}", "key": "pos.y", "order": "desc"}, "outputs": {"items": "cycle.mc.sorted"} },
    { "name": "UNIQ_INIT", "type": "transform", "handler": "array_ops", "inputs": {"op": "unique_by", "items": "${cycle.mc.sorted}", "key": "piece_key"}, "outputs": {"items": "cycle.mc.dedup"} },
    { "name": "SNAP_INIT", "type": "transform", "handler": "pos_to_square", "inputs": {"items": "${cycle.mc.dedup}", "origin": "${worker.chess.origin_center}", "axis": "${worker.chess.axis}", "case_size": "${worker.chess.case_size}", "epsilon": "${worker.chess.epsilon_snap}"}, "outputs": {"map": "cycle.prev.positions"} },

    { "name": "MSG_SPAWN_DONE", "type": "io", "handler": "http_tool", "inputs": {"tool":"minecraft_control","operation":"execute_command","command":"say [INIT] Pieces placed"} },

    { "name": "SNAP_DONE", "type": "transform", "handler": "set_value", "inputs": {"value": true} }
  ],
  "edges": [
    {"from": "SPAWN_START", "to": "CHECK_EXISTING"},

    {"from": "CHECK_EXISTING", "to": "HAS_EXISTING"},
    {"from": "HAS_EXISTING", "to": "LIST_INIT", "when": "true"},

    {"from": "HAS_EXISTING", "to": "SET_WHITE_SQUARES", "when": "false"},
    {"from": "SET_WHITE_SQUARES", "to": "SET_BLACK_SQUARES"},
    {"from": "SET_BLACK_SQUARES", "to": "FILTER_WHITE"},
    {"from": "FILTER_WHITE", "to": "FILTER_BLACK"},

    {"from": "FILTER_BLACK", "to": "TPL_WHITE_SUMMON"},
    {"from": "TPL_WHITE_SUMMON", "to": "DO_SUMMONS_WHITE"},

    {"from": "DO_SUMMONS_WHITE", "to": "TPL_BLACK_SUMMON"},
    {"from": "TPL_BLACK_SUMMON", "to": "DO_SUMMONS_BLACK"},

    {"from": "DO_SUMMONS_BLACK", "to": "INIT_LOCK"},
    {"from": "INIT_LOCK", "to": "LIST_INIT"},

    {"from": "LIST_INIT", "to": "NORM_INIT"},
    {"from": "NORM_INIT", "to": "STABLE_INIT"},
    {"from": "STABLE_INIT", "to": "SORT_INIT"},
    {"from": "SORT_INIT", "to": "UNIQ_INIT"},
    {"from": "UNIQ_INIT", "to": "SNAP_INIT"},
    {"from": "SNAP_INIT", "to": "MSG_SPAWN_DONE"},
    {"from": "MSG_SPAWN_DONE", "to": "SNAP_DONE"}
  ]
}
