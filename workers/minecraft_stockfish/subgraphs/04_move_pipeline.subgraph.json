{
  "id":"MOVE_PIPELINE",
  "version":"1.3",
  "description":"Poll board for a unique move; timeout if elapsed > worker.turns.max_seconds; on move: update prev snapshot, build UCI.",
  "interface":{"entry":"MP_GET_NOW","exits":{"timeout":"EXIT_TIMEOUT","moved":"EXIT_MOVED"}},
  "nodes":[
    {"name":"MP_GET_NOW","type":"io","handler":"http_tool",
     "inputs":{"tool":"date","operation":"now","format":"iso","timezone":"UTC"},
     "outputs":{"result":"cycle.timer.now"}},

    {"name":"MP_TIMER_DIFF","type":"transform","handler":"date_ops",
     "inputs":{"ops":[{"op":"diff","a":"${cycle.timer.now}","b":"${cycle.game.last_turn_ts}","unit":"seconds","save_as":"elapsed"}]},
     "outputs":{"elapsed":"cycle.timer.elapsed_s"}},

    {"name":"MP_TIMER_DECIDE","type":"decision",
     "decision":{"kind":"compare","input":"${cycle.timer.elapsed_s}","operator":">","value":"${worker.turns.max_seconds}"}},

    {"name":"MD_LIST","type":"io","handler":"http_tool",
     "inputs":{"tool":"minecraft_control","operation":"list_entities","selector":"@e[tag=chess_piece]",
               "fields":["uuid","custom_name","pos","tags"],"limit":64},
     "outputs":{"result":"cycle.mc.raw"}},

    {"name":"MD_NORM","type":"transform","handler":"normalize_entities","inputs":{"items":"${cycle.mc.raw}"},"outputs":{"items":"cycle.mc.norm"}},
    {"name":"MD_SORT","type":"transform","handler":"array_ops","inputs":{"op":"sort_by","items":"${cycle.mc.norm}","key":"pos.y","order":"desc"},"outputs":{"items":"cycle.mc.sorted"}},
    {"name":"MD_UNIQ","type":"transform","handler":"array_ops","inputs":{"op":"unique_by","items":"${cycle.mc.sorted}","key":"piece_key"},"outputs":{"items":"cycle.mc.dedup"}},
    {"name":"MD_SNAP","type":"transform","handler":"pos_to_square",
     "inputs":{"items":"${cycle.mc.dedup}","origin":"${worker.chess.origin_center}","axis":"${worker.chess.axis}",
               "case_size":"${worker.chess.case_size}","epsilon":"${worker.chess.epsilon_snap}"},
     "outputs":{"map":"cycle.curr.positions"}},

    {"name":"MD_CMP","type":"transform","handler":"compare_positions",
     "inputs":{"prev":"${cycle.prev.positions}","curr":"${cycle.curr.positions}"},
     "outputs":{"unique":"cycle.move.unique","piece_key":"cycle.move.piece_key","from":"cycle.move.from","to":"cycle.move.to"}},

    {"name":"MD_DEC_UNIQUE","type":"decision","decision":{"kind":"truthy","input":"${cycle.move.unique}"}},

    {"name":"MP_SLEEP","type":"transform","handler":"sleep","inputs":{"ms":5000}},

    {"name":"MD_SET_PREV","type":"transform","handler":"set_value","inputs":{"value":"${cycle.curr.positions}"},"outputs":{"result":"cycle.prev.positions"}},

    {"name":"MD_UCI","type":"transform","handler":"uci_build",
     "inputs":{"from":"${cycle.move.from}","to":"${cycle.move.to}"},
     "outputs":{"uci":"cycle.move.uci"}},

    {"name":"EXIT_MOVED","type":"transform","handler":"set_value","inputs":{"value":true}},
    {"name":"EXIT_TIMEOUT","type":"transform","handler":"set_value","inputs":{"value":true}}
  ],
  "edges":[
    {"from":"MP_GET_NOW","to":"MP_TIMER_DIFF"},
    {"from":"MP_TIMER_DIFF","to":"MP_TIMER_DECIDE"},
    {"from":"MP_TIMER_DECIDE","to":"EXIT_TIMEOUT","when":"true"},
    {"from":"MP_TIMER_DECIDE","to":"MD_LIST","when":"false"},

    {"from":"MD_LIST","to":"MD_NORM"},
    {"from":"MD_NORM","to":"MD_SORT"},
    {"from":"MD_SORT","to":"MD_UNIQ"},
    {"from":"MD_UNIQ","to":"MD_SNAP"},
    {"from":"MD_SNAP","to":"MD_CMP"},
    {"from":"MD_CMP","to":"MD_DEC_UNIQUE"},

    {"from":"MD_DEC_UNIQUE","to":"MD_SET_PREV","when":"true"},
    {"from":"MD_SET_PREV","to":"MD_UCI"},
    {"from":"MD_UCI","to":"EXIT_MOVED"},

    {"from":"MD_DEC_UNIQUE","to":"MP_SLEEP","when":"false"},
    {"from":"MP_SLEEP","to":"MP_GET_NOW"}
  ]
}
